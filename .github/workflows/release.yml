name: Build & Release (macOS)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build/release (e.g. v1.0.0). Leave empty to build current ref only."
        required: false
        type: string

permissions:
  contents: write

jobs:
  build-release:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout requested tag (manual)
        if: ${{ inputs.tag != '' }}
        env:
          TAG: ${{ inputs.tag }}
        run: |
          set -euxo pipefail
          git fetch --tags --force
          if git rev-parse -q --verify "refs/tags/$TAG" >/dev/null; then
            git checkout "refs/tags/$TAG"
          else
            echo "ERROR: Tag '$TAG' not found. Create it first or leave the input empty to build the current ref."
            exit 1
          fi

      - name: Build (Release)
        run: |
          set -euxo pipefail
          xcodebuild -version
          xcodebuild \
            -project MacStatus.xcodeproj \
            -target MacStatus \
            -configuration Release \
            -sdk macosx \
            SYMROOT="$PWD/build" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            build

      - name: Code sign (ad-hoc, enable sandbox)
        run: |
          set -euxo pipefail
          APP_PATH="build/Release/MacStatus.app"
          test -d "$APP_PATH"
          codesign --force --deep --sign - --entitlements MacStatus/MacStatus.entitlements "$APP_PATH"
          codesign --verify --deep --strict "$APP_PATH"

      - name: Package (.zip)
        run: |
          set -euxo pipefail
          APP_PATH="build/Release/MacStatus.app"
          test -d "$APP_PATH"
          REF_NAME="${{ inputs.tag || github.ref_name }}"
          ZIP_NAME="MacStatus-${REF_NAME}-macos.zip"
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "$ZIP_NAME"
          echo "ZIP_NAME=$ZIP_NAME" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}

      - name: Create GitHub Release
        if: ${{ startsWith(github.ref, 'refs/tags/') || inputs.tag != '' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag || github.ref_name }}
          files: ${{ env.ZIP_NAME }}
          body: |
            ## macOS 权限提示（无法打开/已损坏/身份不明开发者）

            这是一个未公证的 macOS 应用，首次打开可能被 Gatekeeper 拦截。可用以下任一方式放行：

            - Finder 右键 `MacStatus.app` → “打开”
            - `系统设置 -> 隐私与安全性` → 在“已阻止打开”处点“仍要打开”
            - 终端解除隔离（把路径替换成你的实际位置）：
              ```bash
              xattr -dr com.apple.quarantine /Applications/MacStatus.app
              ```

          generate_release_notes: true
          append_body: true
